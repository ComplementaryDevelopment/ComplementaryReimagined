name: Project Build
run-name: "ğŸ“¦ Project Build #${{ github.run_number }}"
on:
  push:
    branches:
      - dev
      - main
    # paths:
    #   - 'shaders/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEV_ENVIRONMENT: ${{ github.ref_name != 'main' }}
  PROJECT_NAME: TerraFirmaGreg-Shaders

jobs:    
  info:
    name: ğŸ–¥ï¸ Project Info
    runs-on: ubuntu-latest
    if: ${{  github.repository_owner == 'TerraFirmaGreg-Team' }}
    outputs:
      project_version: ${{ steps.check.outputs.project_version }}
      project_name: ${{ steps.check.outputs.project_name }}

    steps:
        - name: ğŸ“¦ Checkout
          uses: actions/checkout@v5.0.0
          with:
            fetch-depth: 0

        - name: ğŸ” Check
          id: check
          shell: bash
          run: |  
            echo "project_version=build_#${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "project_name=${{ env.PROJECT_NAME }}" >> $GITHUB_OUTPUT
            

  build-project:
    name: ğŸ“¦ Build Project
    needs: [info]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
      
      - name: ğŸ“ Preparing the artifact Unbound
        run: |
          mkdir -p build/unbound
          cp -r shaders/ build/unbound/
          cd build/unbound
          sed -i 's/#define SHADER_STYLE .* \/\/\[1 4\]/#define SHADER_STYLE 1 \/\/\[1 4\]/g' shaders/lib/common.glsl
          zip -r ${{ needs.info.outputs.project_name }}-Unbound-${{ needs.info.outputs.project_version }}.zip shaders/
          
      - name: ğŸš€ Upload artifact Unbound
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ needs.info.outputs.project_name }}-Unbound-${{ needs.info.outputs.project_version }}
          path: ./build/unbound/${{ needs.info.outputs.project_name }}-Unbound-${{ needs.info.outputs.project_version }}.zip
          if-no-files-found: error

      - name: ğŸ“ Preparing the artifact Reimagined
        run: |
          mkdir -p build/reimagined
          cp -r shaders/ build/reimagined/
          cd build/reimagined
          sed -i 's/#define SHADER_STYLE .* \/\/\[1 4\]/#define SHADER_STYLE 4 \/\/\[1 4\]/g' shaders/lib/common.glsl
          zip -r ./build/reimagined/${{ needs.info.outputs.project_name }}-Reimagined-${{ needs.info.outputs.project_version }}.zip shaders/
          
      - name: ğŸš€ Upload artifact Reimagined
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ needs.info.outputs.project_name }}-Reimagined-${{ needs.info.outputs.project_version }}
          path: ${{ needs.info.outputs.project_name }}-Reimagined-${{ needs.info.outputs.project_version }}.zip
          if-no-files-found: error